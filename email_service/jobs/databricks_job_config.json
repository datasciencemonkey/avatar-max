{
  "name": "process-superhero-email-queue",
  "email_notifications": {
    "on_failure": ["admin@innovationgarage.com"],
    "no_alert_for_skipped_runs": true
  },
  "webhook_notifications": {},
  "timeout_seconds": 3600,
  "max_concurrent_runs": 1,
  "tasks": [
    {
      "task_key": "process_email_queue",
      "description": "Process pending superhero avatar emails from the queue",
      "run_if": "ALL_SUCCESS",
      "python_wheel_task": {
        "package_name": "superhero_email_processor",
        "entry_point": "process_emails",
        "parameters": [
          "--batch-size", "50"
        ]
      },
      "job_cluster_key": "email_processor_cluster",
      "timeout_seconds": 600,
      "retry_on_timeout": true,
      "max_retries": 2,
      "min_retry_interval_millis": 60000,
      "libraries": [
        {
          "pypi": {
            "package": "sqlalchemy==2.0.36"
          }
        },
        {
          "pypi": {
            "package": "psycopg2-binary==2.9.10"
          }
        },
        {
          "pypi": {
            "package": "pillow==11.1.0"
          }
        },
        {
          "pypi": {
            "package": "email-validator==2.2.0"
          }
        }
      ]
    }
  ],
  "job_clusters": [
    {
      "job_cluster_key": "email_processor_cluster",
      "new_cluster": {
        "spark_version": "14.3.x-scala2.12",
        "node_type_id": "i3.xlarge",
        "driver_node_type_id": "i3.xlarge",
        "num_workers": 0,
        "spark_conf": {
          "spark.databricks.cluster.profile": "singleNode",
          "spark.master": "local[*]"
        },
        "spark_env_vars": {
          "BREVO_SMTP_SERVER": "{{secrets/email-service/brevo-smtp-server}}",
          "BREVO_SMTP_PORT": "{{secrets/email-service/brevo-smtp-port}}",
          "BREVO_SMTP_LOGIN": "{{secrets/email-service/brevo-smtp-login}}",
          "BREVO_SMTP_PASSWORD": "{{secrets/email-service/brevo-smtp-password}}",
          "EMAIL_FROM_ADDRESS": "{{secrets/email-service/email-from-address}}",
          "EMAIL_FROM_NAME": "{{secrets/email-service/email-from-name}}",
          "EMAIL_REPLY_TO": "{{secrets/email-service/email-reply-to}}",
          "DATABASE_URL": "{{secrets/superhero-app/database-url}}",
          "DATABRICKS_VOLUME": "{{secrets/superhero-app/databricks-volume}}"
        },
        "enable_elastic_disk": true,
        "runtime_engine": "STANDARD"
      }
    }
  ],
  "schedule": {
    "quartz_cron_expression": "0 0/5 * * * ?",
    "timezone_id": "America/New_York",
    "pause_status": "UNPAUSED"
  },
  "tags": {
    "project": "superhero-avatar-generator",
    "environment": "production",
    "service": "email-delivery",
    "team": "innovation-garage"
  },
  "run_as": {
    "user_name": "email-service@innovationgarage.com"
  },
  "format": "MULTI_TASK",
  "queue": {
    "enabled": true
  },
  "budget_policy_id": null,
  "health": {
    "rules": [
      {
        "metric": "RUN_DURATION_SECONDS",
        "op": "GREATER_THAN",
        "value": 300
      }
    ]
  }
}